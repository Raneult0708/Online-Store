{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messagerie - Style WhatsApp</title>
    <link rel="stylesheet" href="{% static "css/commun/message.css" %}">
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar - Liste des conversations -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Messages</h2>
                <div class="user-avatar" title="Mon profil">
                    {{ user_initials }}
                </div>
                {% comment %} <div class="user-avatar" title="Mon profil">
                    {% if utilisateur_actuel.nom %}
                        {{ utilisateur_actuel.nom.0|upper }}
                        {% if utilisateur_actuel.nom|wordcount > 1 %}
                            {{ utilisateur_actuel.nom|split:' '|last|first|upper }}
                        {% endif %}
                    {% else %}
                        U
                    {% endif %}
                </div> {% endcomment %}
            </div>
            
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Rechercher ou d√©marrer une nouvelle discussion">
            </div>

            <div class="conversations-list">
                {% for conversation in conversations_data %}
                <div class="conversation-item" onclick="selectConversation({{ conversation.id }}, '{{ conversation.nom_affichage|escapejs }}')">
                    <div class="conversation-avatar">
                        {{ conversation.initiales }}
                    </div>
                    <div class="conversation-info">
                        <div class="conversation-name">{{ conversation.nom_affichage }}</div>
                        <div class="conversation-preview">
                            {% if conversation.dernier_message %}
                            {{ conversation.dernier_message.contenu|truncatechars:30 }}
                            {% else %}
                            Aucun message
                            {% endif %}
                        </div>
                    </div>
                    <div class="conversation-meta">
                        <div class="conversation-time">
                            {% if conversation.dernier_message and conversation.dernier_message.date_envoi %}
                            {{ conversation.dernier_message.date_envoi|date:"H:i" }}
                            {% endif %}
                        </div>
                        {% if conversation.messages_non_lus > 0 %}
                        <div class="unread-badge">{{ conversation.messages_non_lus }}</div>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div style="padding: 20px; text-align: center; color: #667781;">
                    Aucune conversation
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Chat Principal -->
        <div class="main-chat" id="mainChat">
            <!-- √âcran d'accueil (affich√© quand aucune conversation n'est s√©lectionn√©e) -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-logo">üí¨</div>
                <h1 class="welcome-title">Bienvenue sur votre messagerie</h1>
                <p class="welcome-subtitle">
                    S√©lectionnez une conversation dans la liste de gauche pour commencer √† √©changer.<br>
                    Restez connect√© avec vos contacts en temps r√©el.
                </p>
            </div>

            <!-- Zone de chat (cach√©e initialement) -->
            <div id="chatArea" style="display: none; flex: 1; display: flex; flex-direction: column;">
                <div class="chat-header">
                    <div class="mobile-back-btn" onclick="showSidebar()">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M12 4l1.4 1.4L7.8 11H20v2H7.8l5.6 5.6L12 20l-8-8 8-8z"/>
                        </svg>
                    </div>
                    <div class="chat-avatar" id="chatAvatar">JD</div>
                    <div class="chat-info">
                        <h3 id="chatName">Jean Dupont</h3>
                        <div class="chat-status">En ligne</div>
                    </div>
                </div>

                <div class="messages-container" id="messagesContainer">
                    <!-- Messages dynamiques -->
                    <div class="message received">
                        <div class="message-bubble">
                            <div class="message-content">Salut ! Comment √ßa va ?</div>
                            <div class="message-time">14:28</div>
                        </div>
                    </div>

                    <div class="message sent">
                        <div class="message-bubble">
                            <div class="message-content">√áa va bien merci ! Et toi ?</div>
                            <div class="message-time">14:29</div>
                        </div>
                    </div>

                    <div class="message received">
                        <div class="message-bubble">
                            <div class="message-content">Super ! Tu es libre ce soir pour discuter du projet ?</div>
                            <div class="message-time">14:30</div>
                        </div>
                    </div>
                </div>

                <div class="message-input-container">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Tapez votre message..."
                        rows="1"
                    ></textarea>
                    <button class="send-btn" onclick="sendMessage()">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentConversationId = null;
        let lastMessageId = 0;
        const currentUser = "{{ utilisateur_actuel.nom|escapejs }}";

        // Gestion responsive
        function showSidebar() {
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('mainChat').classList.add('hidden');
        }

        function hideSidebar() {
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('mainChat').classList.remove('hidden');
        }

        // S√©lection d'une conversation
        function selectConversation(conversationId, name) {
            currentConversationId = conversationId;
            
            // Mettre √† jour l'interface
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('chatArea').style.display = 'flex';
            document.getElementById('chatName').textContent = name;
            document.getElementById('chatAvatar').textContent = name.split(' ').map(n => n[0]).join('').toUpperCase();
            
            // Marquer comme active
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Vider les messages pr√©c√©dents
            document.getElementById('messagesContainer').innerHTML = '';
            lastMessageId = 0;
            
            // Charger les messages initiaux
            loadInitialMessages();
            
            // Masquer sidebar sur mobile
            if (window.innerWidth <= 768) {
                hideSidebar();
            }
        }

        // Charger les messages initiaux
        function loadInitialMessages() {
            if (!currentConversationId) return;
            
            fetch(`/chat/conversation/${currentConversationId}/messages/`)
                .then(response => response.json())
                .then(data => {
                    data.messages.forEach(message => {
                        addMessageToChat(message);
                        lastMessageId = Math.max(lastMessageId, message.id);
                    });
                })
                .catch(error => {
                    console.error('Erreur lors du chargement:', error);
                });
        }

        // Envoyer un message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const contenu = input.value.trim();
            
            if (!contenu || !currentConversationId) return;
            
            fetch('/chat/envoyer/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    conversation_id: currentConversationId,
                    contenu: contenu
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Erreur:', data.error);
                    return;
                }
                addMessageToChat(data);
                lastMessageId = data.id;
                input.value = '';
                input.style.height = 'auto';
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
        }

        // Ajouter un message √† l'interface
        function addMessageToChat(message) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.est_mien ? 'sent' : 'received'}`;
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-content">${escapeHtml(message.contenu)}</div>
                    <div class="message-time">${message.date_envoi}</div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // V√©rifier les nouveaux messages
        function checkNewMessages() {
            if (!currentConversationId) return;
            
            fetch(`/chat/conversation/${currentConversationId}/messages/?last_id=${lastMessageId}`)
                .then(response => response.json())
                .then(data => {
                    data.messages.forEach(message => {
                        addMessageToChat(message);
                        lastMessageId = message.id;
                    });
                })
                .catch(error => console.error('Erreur:', error));
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-resize textarea
        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Envoyer avec Entr√©e (Shift+Entr√©e pour nouvelle ligne)
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Recherche dans les conversations
        document.querySelector('.search-input').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.conversation-item').forEach(item => {
                const name = item.querySelector('.conversation-name').textContent.toLowerCase();
                const preview = item.querySelector('.conversation-preview').textContent.toLowerCase();
                if (name.includes(query) || preview.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Polling pour nouveaux messages (toutes les 3 secondes)
        setInterval(checkNewMessages, 3000);

        // Gestion responsive
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('mainChat').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>